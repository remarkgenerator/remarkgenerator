<script>
function sanitize(str) {
  return String(str||'').replace(/[<>]/g, '').replace(/["']/g, '');
}
function generateRef(){
  const t = Date.now().toString().slice(-6);
  const r = Math.floor(Math.random()*9000)+1000;
  return 'WF-'+t+'-'+r;
}
function bnNumber(num) {
  return String(num).replace(/\d/g, d=>"০১২৩৪৫৬৭৮৯"[d]);
}
function bnDate() {
  const d=new Date();
  return `${bnNumber(d.getDate())}/${bnNumber(d.getMonth()+1)}/${bnNumber(d.getFullYear())}`;
}
function addHeirRow(name='', age='', rel='', note=''){
  const tbody = document.querySelector('#heirsTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="serial"></td>
    <td><input class="h-name" type="text" value="${sanitize(name)}"></td>
    <td><input class="h-age" type="text" value="${sanitize(age)}"></td>
    <td><input class="h-rel" type="text" value="${sanitize(rel)}"></td>
    <td><input class="h-note" type="text" value="${sanitize(note)}"></td>
    <td class="center"><button type="button" class="removeRow">Remove</button></td>`;
  tbody.appendChild(tr);
  tr.querySelector('.removeRow').addEventListener('click', ()=> { tr.remove(); updateSerials(); });
  updateSerials();
}
function updateSerials(){
  document.querySelectorAll('#heirsTable tbody tr').forEach((tr,i)=>{
    const cell = tr.querySelector('.serial');
    if(cell) cell.textContent = String(i+1).padStart(2,'0');
  });
}

// ---------------- Font loading ----------------
const remoteFontUrl = "https://raw.githubusercontent.com/googlefonts/noto-fonts/main/hinted/ttf/NotoSansBengali/NotoSansBengali-Regular.ttf";
let fontLoaded = false;
let fontBinaryBase64 = null;

function arrayBufferToBase64(buffer){
  const bytes = new Uint8Array(buffer);
  let binary = '';
  const chunk = 0x8000;
  for (let i = 0; i < bytes.length; i += chunk) {
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
  }
  return btoa(binary);
}

async function fetchAndPrepareFont() {
  try {
    document.getElementById('fontStatus').textContent = 'অনলাইন উৎস থেকে ফন্ট ডাউনলোড হচ্ছে...';
    const resp = await fetch(remoteFontUrl);
    if(!resp.ok) throw new Error('Font fetch failed: '+resp.status);
    const ab = await resp.arrayBuffer();
    fontBinaryBase64 = arrayBufferToBase64(ab);
    fontLoaded = true;
    document.getElementById('fontStatus').textContent = 'বাংলা ফন্ট লোড হয়েছে — এখন PDF সঠিকভাবে রেন্ডার হবে।';
    document.getElementById('submitBtn').disabled = false;
  } catch (err) {
    console.warn('Font fetch failed:', err);
    document.getElementById('fontStatus').textContent = 'অনলাইন ফন্ট লোড হয়নি — ফাইল আপলোড করুন।';
    document.getElementById('fontFallback').classList.remove('hidden');
  }
}

// fallback font upload
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('submitBtn').disabled = true; // font না আসা পর্যন্ত বন্ধ
  const fileInput = document.getElementById('fontFileInput');
  if(fileInput){
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      document.getElementById('fontStatus').textContent = 'আপলোডকৃত ফন্ট লোড হচ্ছে...';
      const ab = await f.arrayBuffer();
      fontBinaryBase64 = arrayBufferToBase64(ab);
      fontLoaded = true;
      document.getElementById('fontStatus').textContent = 'আপলোডকৃত ফন্ট লোড হয়েছে — এখন PDF সঠিকভাবে রেন্ডার হবে।';
      document.getElementById('fontFallback').classList.add('hidden');
      document.getElementById('submitBtn').disabled = false;
    });
  }
  fetchAndPrepareFont();
});

// ---------------- PDF Generation ----------------
async function generatePDF(data){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');

  if(fontLoaded && fontBinaryBase64){
    const fontFileName = "NotoSansBengali-Regular.ttf";
    doc.addFileToVFS(fontFileName, fontBinaryBase64);
    doc.addFont(fontFileName, "NotoSansBengali", "normal");
    doc.setFont("NotoSansBengali");
  }

  const margin = 40;
  let y = 40;
  const pageHeight = doc.internal.pageSize.getHeight();
  const pageWidth = doc.internal.pageSize.getWidth();

  // logo
  await new Promise((res)=>{
    const img = new Image();
    img.src = './logo.png';
    img.onload = function(){
      try { doc.addImage(img, 'PNG', margin, y, 80, 50); y += 60; } catch(e){}
      res();
    };
    img.onerror = ()=> res();
  });

  doc.setFontSize(16);
  doc.text(data.formName || 'ওয়ারিশন সনদ', pageWidth/2, y, {align:'center'});
  y += 24;

  doc.setFontSize(10);
  doc.text(`রেফারেন্স: ${data.ref}`, margin, y); y+=16;
  doc.text(`তারিখ: ${bnDate()}`, margin, y); y+=18;

  doc.setFontSize(12);
  doc.text('মৃত ব্যক্তির তথ্য:', margin, y); y+=16;
  doc.setFontSize(10);

  const leftColX = margin;
  const rightColX = margin + 300;

  doc.text(`নাম: ${data.deceasedName || ''}`, leftColX, y);
  doc.text(`পিতা/স্বামী: ${data.fatherName || ''}`, rightColX, y); y += 14;
  doc.text(`মহল্লা: ${data.mohalla || ''}`, leftColX, y);
  doc.text(`ওয়ার্ড: ${data.ward || ''}`, rightColX, y); y += 14;
  doc.text(`ডাকঘর: ${data.postOffice || ''}`, leftColX, y);
  doc.text(`উপজেলা/থানা: ${data.thana || ''}`, rightColX, y); y += 14;
  doc.text(`জেলা: ${data.district || ''}`, leftColX, y); y += 20;

  doc.setFontSize(12);
  doc.text('ওয়ারিশদের তালিকা:', margin, y); y += 16;
  doc.setFontSize(10);

  const col1 = margin; 
  const col2 = margin + 40; 
  const col3 = margin + 320; 
  const col4 = margin + 380; 
  const col5 = margin + 460; 

  const lineHeight = 14;

  if(!data.heirs || data.heirs.length === 0){
    doc.text('কোনও ওয়ারিশ তথ্য দেওয়া হয়নি।', margin, y); y += lineHeight;
  } else {
    data.heirs.forEach((h, idx) => {
      if(y > pageHeight - 120){
        doc.addPage();
        y = 40;
        doc.setFontSize(10);
      }
      doc.text(String(idx+1).padStart(2,'0'), col1, y);
      const nameLines = doc.splitTextToSize(h.name || '', col3 - col2 - 6);
      doc.text(nameLines, col2, y);
      doc.text(h.age || '', col3, y);
      doc.text(h.rel || '', col4, y);
      const noteLines = doc.splitTextToSize(h.note || '', pageWidth - col5 - margin);
      doc.text(noteLines, col5, y);
      const maxLines = Math.max(nameLines.length, noteLines.length, 1);
      y += lineHeight * maxLines;
    });
  }

  y += 18;
  if(y > pageHeight - 120){
    doc.addPage();
    y = 60;
  }

  doc.text('স্বাক্ষর: ______________________', margin, y);
  if(data.phone) doc.text(`ফোন: ${data.phone}`, margin, pageHeight - 40);
  if(data.email) doc.text(`ইমেইল: ${data.email}`, margin + 240, pageHeight - 40);

  const safeRef = (data.ref || 'warish').replace(/[^a-zA-Z0-9_\-]/g, '_');
  doc.save(`${safeRef}_warish.pdf`);
}

// ---------------- Form handlers ----------------
document.addEventListener('DOMContentLoaded', ()=>{
  addHeirRow();
  document.getElementById('addHeirBtn').addEventListener('click', ()=> addHeirRow());

  const form = document.getElementById('warishForm');
  form.addEventListener('submit', function(e){
    e.preventDefault();
    if(!fontLoaded){
      alert('ফন্ট লোড না হওয়া পর্যন্ত অপেক্ষা করুন।');
      return;
    }
    const fd = new FormData(form);
    const data = {};
    for(const [k,v] of fd.entries()) data[k]=sanitize(v.trim());
    data.heirs = [];
    document.querySelectorAll('#heirsTable tbody tr').forEach((tr)=>{
      const name = tr.querySelector('.h-name').value.trim();
      if(!name) return;
      data.heirs.push({
        name: sanitize(name),
        age: sanitize(tr.querySelector('.h-age').value.trim()),
        rel: sanitize(tr.querySelector('.h-rel').value.trim()),
        note: sanitize(tr.querySelector('.h-note').value.trim())
      });
    });
    data.ref = generateRef();

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Generating...';

    generatePDF(data).then(()=>{
      alert('PDF তৈরি হয়ে ডাউনলোড হয়েছে।');
    }).catch(err=>{
      console.error(err);
      alert('PDF তৈরিতে সমস্যা হয়েছে।');
    }).finally(()=>{
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit and Generate PDF';
    });
  });
});
</script>
