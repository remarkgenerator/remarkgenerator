<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ওয়ারিশন সনদ — Auto PDF</title>

  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body{font-family: "Noto Sans Bengali", Arial, sans-serif;background:#f3f4f6;margin:0;padding:20px}
    .container{max-width:900px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.06)}
    header{text-align:center;margin-bottom:10px}
    header img{max-height:70px}
    h1{margin:6px 0;font-size:22px}
    .small{color:#666;font-size:13px}
    .row{margin-bottom:10px}
    label{display:block;font-weight:700;margin-bottom:6px}
    input[type=text], textarea, select {width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:15px}
    button, .btn{background:#0b5ed7;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
    #heirsTable{width:100%;border-collapse:collapse;margin:10px 0}
    #heirsTable th,#heirsTable td{border:1px solid #e0e0e0;padding:6px;text-align:left}
    .row-inline{display:flex;gap:8px}
    .row-inline input{flex:1}
    .removeRow{background:#e74c3c;padding:4px 8px;border-radius:4px;border:none;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}
    #note{font-size:13px;color:#444;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img id="logo" src="logo.png" alt="Logo" onerror="this.style.display='none'">
      <h1>ওয়ারিশন সনদ ফর্ম</h1>
      <p class="small">তথ্য পূরণ করে Submit দিলে পিডিএফ স্বয়ংক্রিয়ভাবে ডাউনলোড হবে।</p>
    </header>

    <main id="main-area">
      <form id="warishForm">
        <div class="row"><label>ফর্ম নাম</label><input name="formName" type="text" value="ওয়ারিশন সনদ" required></div>
        <div class="row"><label>ফর্ম নম্বর (ঐচ্ছিক)</label><input name="formNumber" type="text"></div>

        <h3>মৃত ব্যক্তির তথ্য</h3>
        <div class="row"><label>মৃত ব্যক্তির নাম</label><input name="deceasedName" type="text" required></div>
        <div class="row"><label>পিতা/স্বামী</label><input name="fatherName" type="text" required></div>
        <div class="row"><label>মহল্লা</label><input name="mohalla" type="text" required></div>
        <div class="row"><label>ওয়ার্ড নং</label><input name="ward" type="text" required></div>
        <div class="row"><label>ডাকঘর</label><input name="postOffice" type="text" required></div>
        <div class="row"><label>উপজেলা/থানা</label><input name="thana" type="text" required></div>
        <div class="row"><label>জেলা</label><input name="district" type="text" required></div>

        <h3>ওয়ারিশদের তালিকা</h3>
        <table id="heirsTable">
          <thead>
            <tr><th>ক্রমিক নং</th><th>নাম</th><th>বয়স</th><th>সম্পর্ক</th><th>মন্তব্য</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="margin-bottom:10px">
          <button type="button" id="addHeirBtn" class="btn">+ ওয়ারিশ যোগ করুন</button>
        </div>

        <div class="row">
          <label>তুমার ফোন (PDF এ রাখা যাবে)</label>
          <input name="phone" type="text" placeholder="০১৭XXXXXXXX" >
        </div>
        <div class="row">
          <label>তুমার ইমেইল (ঐচ্ছিক)</label>
          <input name="email" type="text" placeholder="example@mail.com" >
        </div>

        <div class="row" style="margin-top:12px">
          <button type="submit" id="submitBtn">Submit and Generate PDF</button>
        </div>
        <p id="note">নোট: এখানে Submit দিলে পিডিএফ ব্রাউজার থেকেই ডাউনলোড হবে। (পেমেন্ট ব্যবস্থা আলাদা)</p>
      </form>
    </main>
  </div>

  <script>
  // ---------------- Utilities ----------------
  function generateRef(){
    const t = Date.now().toString().slice(-6);
    const r = Math.floor(Math.random()*9000)+1000;
    return 'WF-'+t+'-'+r;
  }

  function addHeirRow(name='', age='', rel='', note=''){
    const tbody = document.querySelector('#heirsTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="serial"></td>
      <td><input class="h-name" type="text" value="${(name||'').replace(/"/g,'&quot;')}"></td>
      <td><input class="h-age" type="text" value="${(age||'').replace(/"/g,'&quot;')}"></td>
      <td><input class="h-rel" type="text" value="${(rel||'').replace(/"/g,'&quot;')}"></td>
      <td><input class="h-note" type="text" value="${(note||'').replace(/"/g,'&quot;')}"></td>
      <td><button type="button" class="removeRow">Remove</button></td>`;
    tbody.appendChild(tr);
    tr.querySelector('.removeRow').addEventListener('click', ()=> { tr.remove(); updateSerials(); });
    updateSerials();
  }

  function updateSerials(){
    document.querySelectorAll('#heirsTable tbody tr').forEach((tr,i)=>{
      const cell = tr.querySelector('.serial');
      if(cell) cell.textContent = String(i+1).padStart(2,'0');
    });
  }

  // ---------------- PDF Generation ----------------
  async function generatePDF(data){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','pt','a4');
    const margin = 40;
    let y = 40;

    // try load logo.png if present
    async function addLogo(){
      return new Promise((res) => {
        const img = new Image();
        img.src = './logo.png';
        img.onload = function(){
          try{
            doc.addImage(img, 'PNG', margin, y, 80, 50);
            y += 60;
          }catch(e){}
          res();
        };
        img.onerror = function(){ res(); };
      });
    }
    await addLogo();

    doc.setFontSize(16);
    doc.text(data.formName || 'ওয়ারিশন সনদ', doc.internal.pageSize.getWidth()/2, y, {align:'center'});
    y += 24;

    doc.setFontSize(10);
    doc.text(`রেফারেন্স: ${data.ref}`, margin, y); y+=16;
    doc.text(`তারিখ: ${new Date().toLocaleDateString('bn-BD')}`, margin, y); y+=16;

    // Deceased info
    doc.setFontSize(12);
    doc.text('মৃত ব্যক্তির তথ্য:', margin, y); y+=16;
    const leftColX = margin;
    const rightColX = 320;
    doc.setFontSize(10);
    doc.text(`নাম: ${data.deceasedName || ''}`, leftColX, y);
    doc.text(`পিতা/স্বামী: ${data.fatherName || ''}`, rightColX, y); y+=14;
    doc.text(`মহল্লা: ${data.mohalla || ''}`, leftColX, y);
    doc.text(`ওয়ার্ড: ${data.ward || ''}`, rightColX, y); y+=14;
    doc.text(`ডাকঘর: ${data.postOffice || ''}`, leftColX, y);
    doc.text(`উপজেলা/থানা: ${data.thana || ''}`, rightColX, y); y+=14;
    doc.text(`জেলা: ${data.district || ''}`, leftColX, y); y+=20;

    // Heirs header
    doc.setFontSize(12);
    doc.text('ওয়ারিশদের তালিকা:', margin, y); y+=16;
    doc.setFontSize(10);

    // Table-like layout
    const lineHeight = 14;
    const col1 = margin; // serial
    const col2 = margin + 30; // name
    const col3 = margin + 260; // age
    const col4 = margin + 300; // rel
    const col5 = margin + 380; // note

    if((data.heirs||[]).length === 0){
      doc.text('কোনও ওয়ারিশ তথ্য দেওয়া হয়নি।', margin, y); y+=lineHeight;
    } else {
      data.heirs.forEach((h, idx) => {
        const text = `${idx+1}. ${h.name || ''}`;
        // check page overflow
        if(y > 760){
          doc.addPage();
          y = 40;
        }
        doc.text(String(idx+1).padStart(2,'0'), col1, y);
        // wrap name if long
        const nameLines = doc.splitTextToSize(h.name || '', 220);
        doc.text(nameLines, col2, y);
        // age & rel & note on same line if short
        doc.text(h.age || '', col3, y);
        doc.text(h.rel || '', col4, y);
        if(h.note) {
          const noteLines = doc.splitTextToSize(h.note, 150);
          doc.text(noteLines, col5, y);
          // increase y by number of lines if name or note wrapped
          const maxLines = Math.max(nameLines.length, noteLines.length);
          y += lineHeight * maxLines;
        } else {
          y += lineHeight * nameLines.length;
        }
      });
    }

    y += 20;
    // signature
    if(y > 700){ doc.addPage(); y = 60; }
    doc.text('স্বাক্ষর: ______________________', margin, y);
    y += 20;

    // Contact info at bottom
    doc.setFontSize(10);
    if(data.phone) doc.text(`ফোন: ${data.phone}`, margin, doc.internal.pageSize.getHeight() - 60);
    if(data.email) doc.text(`ইমেইল: ${data.email}`, margin + 200, doc.internal.pageSize.getHeight() - 60);

    // Save file
    const fileName = `${data.ref || 'warish'}_warish.pdf`;
    doc.save(fileName);
  }

  // ---------------- Form handlers ----------------
  document.addEventListener('DOMContentLoaded', ()=>{
    // add initial heir
    addHeirRow();

    document.getElementById('addHeirBtn').addEventListener('click', ()=> addHeirRow());

    const form = document.getElementById('warishForm');
    form.addEventListener('submit', function(e){
      e.preventDefault();

      // collect data
      const fd = new FormData(form);
      const data = {};
      for(const [k,v] of fd.entries()) data[k]=v.trim();

      // heirs
      data.heirs = [];
      document.querySelectorAll('#heirsTable tbody tr').forEach((tr)=>{
        const name = tr.querySelector('.h-name').value.trim();
        if(!name) return;
        const age = tr.querySelector('.h-age').value.trim();
        const rel = tr.querySelector('.h-rel').value.trim();
        const note = tr.querySelector('.h-note').value.trim();
        data.heirs.push({name, age, rel, note});
      });

      // reference
      data.ref = generateRef();

      // generate PDF
      generatePDF(data).then(()=>{
        // optional: show small success message or clear form
        alert('PDF তৈরি হয়ে ডাউনলোড হয়েছে।');
        // you can clear form if you want:
        // form.reset();
        // document.querySelectorAll('#heirsTable tbody tr').forEach(tr=>tr.remove());
        // addHeirRow();
      }).catch(err=>{
        console.error(err);
        alert('PDF তৈরিতে সমস্যা হয়েছে, Console দেখো।');
      });

    }); // submit
  });
  </script>
</body>
</html>
