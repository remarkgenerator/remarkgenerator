<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ওয়ারিশন সনদ — Auto PDF (Ready)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* তোমার আগের থিম 그대로 */
body { font-family: "Noto Sans Bengali", Arial, sans-serif; background:#f3f4f6; margin:0; padding:20px; }
.container { max-width:900px; margin:0 auto; background:#fff; padding:18px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.06); }
header { text-align:center; margin-bottom:10px; }
header img { max-height:70px }
h1 { margin:6px 0; font-size:22px }
.small { color:#666; font-size:13px }
.row { margin-bottom:10px }
label { display:block; font-weight:700; margin-bottom:6px }
input[type=text], textarea, select { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:15px }
button, .btn { background:#0b5ed7; color:#fff; padding:8px 12px; border:none; border-radius:6px; cursor:pointer }
#heirsTable { width:100%; border-collapse:collapse; margin:10px 0 }
#heirsTable th, #heirsTable td { border:1px solid #e0e0e0; padding:6px; text-align:left; vertical-align:top }
.row-inline { display:flex; gap:8px }
.row-inline input { flex:1 }
.removeRow { background:#e74c3c; padding:4px 8px; border-radius:4px; border:none; color:#fff; cursor:pointer }
.muted { color:#666; font-size:13px }
#note { font-size:13px; color:#444; margin-top:8px }
.muted-small { font-size:12px; color:#777; margin-top:6px }
.hidden { display:none; }
.center { text-align:center; }
.flex { display:flex; gap:8px; align-items:center; }
</style>
</head>
<body>
<div class="container">
<header>
<img id="logo" src="logo.png" alt="Logo" onerror="this.style.display='none'">
<h1>ওয়ারিশন সনদ ফর্ম</h1>
<p class="small">তথ্য পূরণ করে Submit দিলে পিডিএফ স্বয়ংক্রিয়ভাবে ডাউনলোড হবে।</p>
</header>
<main id="main-area">
<form id="warishForm">

<!-- মৃত ব্যক্তির তথ্য -->
<div class="row"><label>ফর্ম নাম</label><input name="formName" type="text" value="বিভাগ জেলা ও পৌরসভার নাম লিখুন" required></div>
<div class="row"><label>ফর্ম নম্বর (ঐচ্ছিক)</label><input name="formNumber" type="text"></div>
<h3>মৃত ব্যক্তির তথ্য</h3>
<div class="row"><label>মৃত ব্যক্তির নাম</label><input name="deceasedName" type="text" required></div>
<div class="row"><label>পিতা/স্বামী</label><input name="fatherName" type="text" required></div>
<div class="row"><label>মহল্লা</label><input name="mohalla" type="text" required></div>
<div class="row"><label>ওয়ার্ড নং</label><input name="ward" type="text" required></div>
<div class="row"><label>ডাকঘর</label><input name="postOffice" type="text" required></div>
<div class="row"><label>উপজেলা/থানা</label><input name="thana" type="text" required></div>
<div class="row"><label>জেলা</label><input name="district" type="text" required></div>

<!-- ওয়ারিশ তালিকা -->
<h3>ওয়ারিশদের তালিকা</h3>
<table id="heirsTable">
<thead>
<tr><th style="width:60px">ক্রমিক নং</th><th>নাম</th><th style="width:80px">বয়স</th><th style="width:120px">সম্পর্ক</th><th>মন্তব্য</th><th style="width:80px"></th></tr>
</thead>
<tbody></tbody>
</table>
<div style="margin-bottom:10px" class="flex">
<button type="button" id="addHeirBtn" class="btn">+ ওয়ারিশ যোগ করুন</button>
<div class="muted-small">(নাম খালি ছেড়ে দিলে সেই রো PDF-এ যোগ হবে না)</div>
</div>

<div class="row"><label>আপনার ফোন</label><input name="phone" type="text" placeholder="০১XXXXXXXXX"></div>
<div class="row"><label>আপনার ইমেইল (ঐচ্ছিক)</label><input name="email" type="text" placeholder="example@mail.com"></div>

<div id="fontStatus" class="muted-small">বাংলা ফন্ট লোড হচ্ছে...</div>
<div class="row" style="margin-top:12px"><button type="submit" id="submitBtn">Submit and Generate PDF</button></div>
<p id="note">নোট: Submit দিলে পিডিএফ ব্রাউজার থেকেই ডাউনলোড হবে।</p>
</form>
</main>
</div>

<script>
// ===== Base64 ফন্ট ডেটা (সংক্ষেপিত উদাহরণ) =====
const notoBengaliBase64 = "AAEAAAALAIAAAwAwT1Mv..."; // আসল Base64 বসাতে হবে

// Utility
function sanitize(str) {
  return String(str||'').replace(/[<>]/g, '').replace(/["']/g, '');
}
function generateRef(){
  const t = Date.now().toString().slice(-6);
  const r = Math.floor(Math.random()*9000)+1000;
  return 'WF-'+t+'-'+r;
}
function bnNumber(num) {
  return String(num).replace(/\d/g, d=>"০১২৩৪৫৬৭৮৯"[d]);
}
function bnDate() {
  const d=new Date();
  return `${bnNumber(d.getDate())}/${bnNumber(d.getMonth()+1)}/${bnNumber(d.getFullYear())}`;
}
function addHeirRow(name='', age='', rel='', note=''){
  const tbody = document.querySelector('#heirsTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="serial"></td>
    <td><input class="h-name" type="text" value="${sanitize(name)}"></td>
    <td><input class="h-age" type="text" value="${sanitize(age)}"></td>
    <td><input class="h-rel" type="text" value="${sanitize(rel)}"></td>
    <td><input class="h-note" type="text" value="${sanitize(note)}"></td>
    <td class="center"><button type="button" class="removeRow">Remove</button></td>`;
  tbody.appendChild(tr);
  tr.querySelector('.removeRow').addEventListener('click', ()=> { tr.remove(); updateSerials(); });
  updateSerials();
}
function updateSerials(){
  document.querySelectorAll('#heirsTable tbody tr').forEach((tr,i)=>{
    const cell = tr.querySelector('.serial');
    if(cell) cell.textContent = String(i+1).padStart(2,'0');
  });
}

// ===== PDF Generation =====
async function generatePDF(data){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','pt','a4');

  // ফন্ট যুক্ত
  doc.addFileToVFS("NotoSansBengali-Regular.ttf", notoBengaliBase64);
  doc.addFont("NotoSansBengali-Regular.ttf", "NotoSansBengali", "normal");
  doc.setFont("NotoSansBengali");

  const margin = 40;
  let y = 40;
  const pageHeight = doc.internal.pageSize.getHeight();
  const pageWidth = doc.internal.pageSize.getWidth();

  // Title
  doc.setFontSize(16);
  doc.text(`${data.formName || 'ওয়ারিশন সনদ'}`, pageWidth/2, y, {align:'center'});
  y += 24;

  doc.setFontSize(10);
  doc.text(`রেফারেন্স: ${data.ref}`, margin, y); y+=16;
  doc.text(`তারিখ: ${bnDate()}`, margin, y); y+=18;

  // Deceased info
  doc.setFontSize(12);
  doc.text(`মৃত ব্যক্তির তথ্য:`, margin, y); y+=16;
  doc.setFontSize(10);

  const leftColX = margin;
  const rightColX = margin + 300;

  doc.text(`নাম: ${data.deceasedName || ''}`, leftColX, y);
  doc.text(`পিতা/স্বামী: ${data.fatherName || ''}`, rightColX, y); y += 14;
  doc.text(`মহল্লা: ${data.mohalla || ''}`, leftColX, y);
  doc.text(`ওয়ার্ড: ${data.ward || ''}`, rightColX, y); y += 14;
  doc.text(`ডাকঘর: ${data.postOffice || ''}`, leftColX, y);
  doc.text(`উপজেলা/থানা: ${data.thana || ''}`, rightColX, y); y += 14;
  doc.text(`জেলা: ${data.district || ''}`, leftColX, y); y += 20;

  // Heirs table
  doc.setFontSize(12);
  doc.text(`ওয়ারিশদের তালিকা:`, margin, y); y += 16;
  doc.setFontSize(10);

  if(!data.heirs || data.heirs.length === 0){
    doc.text('কোনও ওয়ারিশ তথ্য দেওয়া হয়নি।', margin, y); y += 14;
  } else {
    data.heirs.forEach((h, idx) => {
      if(y > pageHeight - 120){
        doc.addPage();
        y = 40;
      }
      doc.text(String(idx+1).padStart(2,'0'), margin, y);
      doc.text(h.name || '', margin+40, y);
      doc.text(h.age || '', margin+320, y);
      doc.text(h.rel || '', margin+380, y);
      doc.text(h.note || '', margin+460, y);
      y += 14;
    });
  }

  y += 18;
  if(y > pageHeight - 120){
    doc.addPage();
    y = 60;
  }

  doc.text('স্বাক্ষর: ______________________', margin, y);

  // Footer
  if(data.phone) doc.text(`ফোন: ${data.phone}`, margin, pageHeight - 40);
  if(data.email) doc.text(`ইমেইল: ${data.email}`, margin + 240, pageHeight - 40);

  const safeRef = (data.ref || 'warish').replace(/[^a-zA-Z0-9_-]/g, '_');
  doc.save(`${safeRef}_warish.pdf`);
}

// ===== Form Handling =====
document.addEventListener('DOMContentLoaded', ()=>{
  addHeirRow();
  document.getElementById('addHeirBtn').addEventListener('click', ()=> addHeirRow());

  const form = document.getElementById('warishForm');
  form.addEventListener('submit', function(e){
    e.preventDefault();
    const fd = new FormData(form);
    const data = {};
    for(const [k,v] of fd.entries()) data[k] = sanitize(v.trim());

    data.heirs = [];
    document.querySelectorAll('#heirsTable tbody tr').forEach((tr)=>{
      const name = tr.querySelector('.h-name').value.trim();
      if(!name) return;
      data.heirs.push({
        name: sanitize(name),
        age: sanitize(tr.querySelector('.h-age').value.trim()),
        rel: sanitize(tr.querySelector('.h-rel').value.trim()),
        note: sanitize(tr.querySelector('.h-note').value.trim())
      });
    });

    data.ref = generateRef();
    generatePDF(data);
  });
});
</script>
</body>
  </html>
