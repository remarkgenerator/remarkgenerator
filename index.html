<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ওয়ারিশন সনদ — Auto PDF</title>

  <!-- Bengali Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali&display=swap" rel="stylesheet" />

  <!-- html2pdf.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body {
      font-family: "Noto Sans Bengali", Arial, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 20px;
      color: #222;
      line-height: 1.4;
      font-size: 15px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 25px 30px 30px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    header img {
      max-height: 70px;
      margin-bottom: 8px;
    }
    h1 {
      margin: 6px 0 6px;
      font-size: 24px;
      font-weight: 700;
      color: #0b5ed7;
    }
    .small {
      color: #666;
      font-size: 13px;
      font-weight: 500;
    }
    h3 {
      margin-top: 25px;
      margin-bottom: 10px;
      font-weight: 700;
      color: #0b5ed7;
      border-bottom: 2px solid #0b5ed7;
      padding-bottom: 4px;
      font-size: 18px;
    }
    .row {
      margin-bottom: 14px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 15px;
    }
    input[type=text], textarea, select {
      width: 100%;
      padding: 10px 12px;
      border: 1.8px solid #cbd5e1;
      border-radius: 6px;
      font-size: 15px;
      font-family: "Noto Sans Bengali", Arial, sans-serif;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input[type=text]:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #0b5ed7;
      box-shadow: 0 0 8px rgba(11, 94, 215, 0.3);
    }
    button, .btn {
      background: #0b5ed7;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 15px;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover:not(:disabled), .btn:hover:not(:disabled) {
      background-color: #084abf;
    }
    button:disabled, .btn:disabled {
      background-color: #a1a7b3 !important;
      cursor: not-allowed;
    }
    #heirsTable {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0 14px;
      font-size: 14px;
      table-layout: fixed;
    }
    #heirsTable th, #heirsTable td {
      border: 1.5px solid #e0e0e0;
      padding: 8px 10px;
      text-align: left;
      vertical-align: middle;
      word-wrap: break-word;
    }
    #heirsTable th {
      background-color: #f0f6ff;
      font-weight: 700;
      color: #0b5ed7;
    }
    .row-inline {
      display: flex;
      gap: 10px;
    }
    .row-inline input {
      flex: 1;
      padding: 10px 12px;
      font-size: 15px;
    }
    .removeRow {
      background: #e74c3c;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      color: #fff;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      transition: background-color 0.3s ease;
    }
    .removeRow:hover {
      background-color: #c0392b;
    }
    .muted {
      color: #666;
      font-size: 13px;
    }
    #note {
      font-size: 13px;
      color: #444;
      margin-top: 10px;
      font-style: italic;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .row-inline {
        flex-direction: column;
      }
      #heirsTable th, #heirsTable td {
        font-size: 13px;
        padding: 6px 8px;
      }
      button, .btn {
        width: 100%;
      }
    }

    /* PDF Layout */
    #pdfContent {
      font-family: "Noto Sans Bengali", Arial, sans-serif;
      padding: 20px;
      color: #222;
    }
    #pdfContent h1, #pdfContent h3 {
      color: #0b5ed7;
    }
    #pdfContent table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    #pdfContent table, #pdfContent th, #pdfContent td {
      border: 1px solid #333;
    }
    #pdfContent th, #pdfContent td {
      padding: 6px 8px;
      text-align: left;
    }

    /* Popup overlay */
    #popupOverlay, #refCodePopup, #telegramContactPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 25px 30px;
      border-radius: 10px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      text-align: center;
      font-size: 15px;
      color: #222;
      display: none;
    }

    #popup h2, #refCodePopup h2, #telegramContactPopup h2 {
      font-weight: 700;
      color: #dc3545;
    }

    /* Invalid/Valid input styling */
    input#contactRefCodeInput {
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      transition: border 0.3s ease;
    }

    input#contactRefCodeInput.invalid {
      border: 2px solid red;
      box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
    }

    input#contactRefCodeInput.valid {
      border: 2px solid green;
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
    }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <img id="logo" src="logo.png" alt="Logo" onerror="this.style.display='none'">
      <h1>ওয়ারিশন সনদ ফর্ম</h1>
      <p class="small">তথ্য পূরণ করে Submit দিলে Demo PDF স্বয়ংক্রিয়ভাবে ডাউনলোড হবে তবে অফিজিনাল PDF পেতে অবশই টেলিগ্রাম এ তথ্য পাঠান বাটন এ চাপ দেবার পর Admin এর সাথে যোগাযোগ করতে হবে</p>
    </header>

    <main id="main-area">
      <form id="warishForm" autocomplete="off" novalidate>
        <div class="row">
          <label for="formName">ফর্ম নাম</label>
          <input id="formName" name="formName" type="text" required placeholder="বিভাগ জেলা উপজেলা এবং পৌরসভার নাম লিখুন">
        </div>
        <div class="row">
          <label for="formNumber">ফর্ম নম্বর (ঐচ্ছিক)</label>
          <input id="formNumber" name="formNumber" type="text" placeholder="যেমন: ১২৩৪৫৬">
        </div>

        <h3>মৃত ব্যক্তির তথ্য</h3>
        <div class="row">
          <label for="deceasedName">মৃত ব্যক্তির নাম</label>
          <input id="deceasedName" name="deceasedName" type="text" required placeholder="মৃত ব্যক্তির সম্পূর্ণ নাম">
        </div>
        <div class="row">
          <label for="fatherName">পিতা/স্বামী</label>
          <input id="fatherName" name="fatherName" type="text" required placeholder="পিতা অথবা স্বামীর নাম">
        </div>
        <div class="row">
          <label for="mohalla">মহল্লা</label>
          <input id="mohalla" name="mohalla" type="text" required placeholder="মহল্লার নাম">
        </div>
        <div class="row">
          <label for="ward">ওয়ার্ড নং</label>
          <input id="ward" name="ward" type="text" required placeholder="ওয়ার্ড নম্বর">
        </div>
        <div class="row">
          <label for="postOffice">ডাকঘর</label>
          <input id="postOffice" name="postOffice" type="text" required placeholder="ডাকঘরের নাম">
        </div>
        <div class="row">
          <label for="thana">উপজেলা/থানা</label>
          <input id="thana" name="thana" type="text" required placeholder="উপজেলা বা থানা">
        </div>
        <div class="row">
          <label for="district">জেলা</label>
          <input id="district" name="district" type="text" required placeholder="জেলার নাম">
        </div>

        <h3>ওয়ারিশদের তালিকা</h3>
        <table id="heirsTable" aria-label="ওয়ারিশদের তথ্যের তালিকা">
          <thead>
            <tr>
              <th style="width: 5%;">ক্রমিক</th>
              <th style="width: 30%;">নাম</th>
              <th style="width: 15%;">বয়স</th>
              <th style="width: 25%;">সম্পর্ক</th>
              <th style="width: 20%;">মন্তব্য (ঐচ্ছিক)</th>
              <th style="width: 5%;">#</th>
            </tr>
          </thead>
          <tbody id="heirsBody">
            <tr>
              <td class="serial">১</td>
              <td><input type="text" name="heirName[]" required placeholder="নাম লিখুন"></td>
              <td><input type="text" name="age[]" required placeholder="বয়স"></td>
              <td><input type="text" name="relation[]" required placeholder="সম্পর্ক"></td>
              <td><input type="text" name="comment[]" placeholder="মন্তব্য"></td>
              <td><button type="button" class="removeRow" aria-label="সারি মুছুন">&times;</button></td>
            </tr>
          </tbody>
        </table>
        <button type="button" id="addHeir" class="btn" aria-label="নতুন ওয়ারিশ যুক্ত করুন">+ নতুন ওয়ারিশ যুক্ত করুন</button>

        <div class="row" style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
          <button type="submit" id="generatePdfBtn" class="btn" aria-label="পিডিএফ তৈরি করুন">পিডিএফ তৈরি করুন</button>
          <button type="button" id="sendTelegramBtn" class="btn" aria-label="টেলিগ্রামের তথ্য পাঠান" disabled>টেলিগ্রামের তথ্য পাঠান</button>
          <button type="button" id="contactTelegramBtn" class="btn" aria-label="টেলিগ্রামে যোগাযোগ করুন">টেলিগ্রামে যোগাযোগ করুন</button>
        </div>
      </form>
    </main>
  </div>

  <!-- Popup Overlay -->
  <div id="popupOverlay" role="dialog" aria-modal="true" aria-labelledby="popupTitle" aria-describedby="popupDesc">
    <div id="popup">
      <h2 id="popupTitle">⚠️ সতর্কতা</h2>
      <p id="popupDesc">
        অনুগ্রহ করে নিশ্চিত করুন যে আপনার সকল তথ্য সঠিকভাবে পূরণ করা হয়েছে। সাবমিট করার পর তথ্য সম্পাদনার সুযোগ থাকবে না। তাই সাবমিট করার পূর্বে তথ্যগুলি পুনরায় যাচাই করে নিশ্চিত হয়ে সাবমিট করুন।<br>
        <strong> নিয়মসমূহ:</strong>
        <ul>
          <li>পিডিএফ জেনারেট বাটনে চাপ দিলে সরাসরি আপনার পিডিএফ ডাউনলোড হয়ে যাবে।</li>
          <li>পিডিএফ জেনারেট হওয়ার পর অনুগ্রহ করে টেলিগ্রামের তথ্য পাঠান বাটনে চাপ দিন।</li>
          <li>টেলিগ্রামের তথ্য সফলভাবে পাঠানো হলে, আপনার রেফারেন্স কোডসহ সরাসরি এডমিনের সাথে যোগাযোগ করতে টেলিগ্রামের যোগাযোগ বাটনে চাপ দিন।</li>
        </ul>
      </p>
      <p>সাবমিট করার জন্য অপেক্ষা করুন <span id="timer">10</span> সেকেন্ড</p>
      <button id="confirmSubmitBtn" disabled>আমি নিশ্চিত, সাবমিট করুন</button>
      <button id="cancelSubmitBtn" style="margin-left:10px; background:#6c757d;">বাতিল করুন</button>
    </div>
  </div>

  <!-- Reference code popup -->
  <div id="refCodePopup" role="dialog" aria-modal="true" aria-labelledby="refCodeTitle" aria-describedby="refCodeDesc" style="display:none;">
    <div id="popup" style="max-width: 400px;">
      <h2 id="refCodeTitle">আপনার রেফারেন্স কোড</h2>
      <div id="referenceCodeText" tabindex="0" role="textbox" aria-readonly="true"></div>
      <button id="copyRefCodeBtn" class="btn" style="margin-top:5px;">কপি করুন</button>
      <p id="copyMsg" style="display: none;">কপি হয়েছে!</p>
      <button id="closeRefCodePopup" class="btn" style="margin-top:15px;">বন্ধ করুন</button>
    </div>
  </div>

  <!-- Telegram Contact popup -->
  <div id="telegramContactPopup" role="dialog" aria-modal="true" aria-labelledby="contactTitle" aria-describedby="contactDesc" style="display:none;">
    <div id="popup" style="max-width: 400px;">
      <h2 id="contactTitle">টেলিগ্রামে যোগাযোগ</h2>
      <p id="contactDesc">রেফারেন্স কোড দিন যেটা দিয়ে আপনি ফর্ম সাবমিট করেছেন:</p>
      <input type="text" id="contactRefCodeInput" placeholder="রেফারেন্স কোড লিখুন" style="width:100%; padding:8px; margin-bottom:10px; font-size:16px; box-sizing: border-box;" />
      <span id="refCodeValidIcon" aria-hidden="true" style="font-size: 24px; vertical-align: middle; margin-left: 6px;"></span>
      <p id="contactErrorMsg" style="color:red; display:none; font-weight:700;">রেফারেন্স কোড ভুল। অনুগ্রহ করে সঠিক কোড দিন।</p>
      <button id="contactConfirmBtn" class="btn">যোগাযোগ শুরু করুন</button>
      <button id="contactCancelBtn" class="btn" style="margin-top:10px; background:#6c757d;">বাতিল করুন</button>
    </div>
  </div>

  <script>
    // --- Telegram bot config --- 
    const TELEGRAM_BOT_TOKEN = '8289822977:AAHXfya0wathSqLG2x1Xsrv-nR4ECZFhrZ0'; 
    const TELEGRAM_CHAT_ID = '8402648058'; 
    const TELEGRAM_USERNAME = 'remarkgenerator';

    // Helper: বাংলা সংখ্যা রূপান্তর (1 -> ১)
    function toBanglaNumber(num) {
      const banglaDigits = ['০','১','২','৩','৪','৫','৬','৭','৮','৯'];
      return num.toString().split('').map(d => banglaDigits[d] || d).join('');
    }

    // সিরিয়াল আপডেট ফাংশন
    function updateSerials() {
      const serialCells = document.querySelectorAll('#heirsBody .serial');
      serialCells.forEach((cell, i) => {
        cell.textContent = toBanglaNumber(i + 1);
      });
    }

    // Initialize heirs table serial and remove button events
    function initHeirsTable() {
      updateSerials();

      // Add remove event delegation
      document.getElementById('heirsBody').addEventListener('click', e => {
        if (e.target.classList.contains('removeRow')) {
          const tbody = document.getElementById('heirsBody');
          // Minimum 1 heir row must remain
          if (tbody.rows.length > 1) {
            e.target.closest('tr').remove();
            updateSerials();
          } else {
            alert('কমপক্ষে একটি ওয়ারিশ থাকা বাধ্যতামূলক।');
          }
        }
      });
    }

    // Add new heir row
    document.getElementById('addHeir').addEventListener('click', () => {
      const tbody = document.getElementById('heirsBody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td class="serial"></td>
        <td><input type="text" name="heirName[]" required placeholder="নাম লিখুন"></td>
        <td><input type="text" name="age[]" required placeholder="বয়স"></td>
        <td><input type="text" name="relation[]" required placeholder="সম্পর্ক"></td>
        <td><input type="text" name="comment[]" placeholder="মন্তব্য"></td>
        <td><button type="button" class="removeRow" aria-label="সারি মুছুন">&times;</button></td>
      `;
      tbody.appendChild(newRow);
      updateSerials();
    });

    // Generate random 8-char reference code (caps + digits)
    function generateReferenceCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 8; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Show popup overlay (confirm submit)
    const popupOverlay = document.getElementById('popupOverlay');
    const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
    const cancelSubmitBtn = document.getElementById('cancelSubmitBtn');
    const timerSpan = document.getElementById('timer');
    let countdownInterval;

    // Reference code popup elements
    const refCodePopup = document.getElementById('refCodePopup');
    const referenceCodeText = document.getElementById('referenceCodeText');
    const copyRefCodeBtn = document.getElementById('copyRefCodeBtn');
    const copyMsg = document.getElementById('copyMsg');
    const closeRefCodePopup = document.getElementById('closeRefCodePopup');

    // Telegram contact popup elements
    const telegramContactPopup = document.getElementById('telegramContactPopup');
    const contactRefCodeInput = document.getElementById('contactRefCodeInput');
    const refCodeValidIcon = document.getElementById('refCodeValidIcon');
    const contactConfirmBtn = document.getElementById('contactConfirmBtn');
    const contactCancelBtn = document.getElementById('contactCancelBtn');
    const contactErrorMsg = document.getElementById('contactErrorMsg');

    // Store reference code globally after PDF gen
    let currentReferenceCode = '';

    // Countdown function before enabling confirm button
    function startCountdown(seconds = 10) {
      let count = seconds;
      timerSpan.textContent = toBanglaNumber(count);
      confirmSubmitBtn.disabled = true;
      countdownInterval = setInterval(() => {
        count--;
        timerSpan.textContent = toBanglaNumber(count);
        if (count <= 0) {
          clearInterval(countdownInterval);
          confirmSubmitBtn.disabled = false;
          timerSpan.textContent = '';
        }
      }, 1000);
    }

    // Copy reference code text to clipboard
    copyRefCodeBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(currentReferenceCode).then(() => {
        copyMsg.style.display = 'block';
        setTimeout(() => { copyMsg.style.display = 'none'; }, 1500);
      }).catch(() => {
        alert('দুঃখিত, আপনার ভেরিফিকেশন কোড কপি করতে ব্যর্থ হয়েছে। অনুগ্রহ করে ম্যানুয়ালি সিলেক্ট করে কপি করুন');
      });
    });

    // Also allow clicking code text to copy
    referenceCodeText.addEventListener('click', () => {
      navigator.clipboard.writeText(currentReferenceCode).then(() => {
        copyMsg.style.display = 'block';
        setTimeout(() => { copyMsg.style.display = 'none'; }, 1500);
      }).catch(() => {
        alert('দুঃখিত, আপনার ভেরিফিকেশন কোড কপি করতে ব্যর্থ হয়েছে। অনুগ্রহ করে ম্যানুয়ালি সিলেক্ট করে কপি করুন');
      });
    });

    closeRefCodePopup.addEventListener('click', () => {
      refCodePopup.style.display = 'none';
    });

    // Form submit event — show countdown popup
    document.getElementById('warishForm').addEventListener('submit', e => {
      e.preventDefault();

      // Basic HTML5 validation
      if (!e.target.checkValidity()) {
        e.target.reportValidity();
        return;
      }

      popupOverlay.style.display = 'flex';
      startCountdown(10);
    });

    cancelSubmitBtn.addEventListener('click', () => {
      clearInterval(countdownInterval);
      popupOverlay.style.display = 'none';
    });

    // Confirm submit after countdown
    confirmSubmitBtn.addEventListener('click', () => {
      popupOverlay.style.display = 'none';

      // Generate reference code and save globally
      currentReferenceCode = generateReferenceCode();

      // Generate PDF content
      generatePDF();

      // Show reference code popup after PDF download starts
      referenceCodeText.textContent = currentReferenceCode;
      refCodePopup.style.display = 'flex';

      // Enable "Send Telegram" button now
      sendTelegramBtn.disabled = false;

      // Disable Submit button and form after submit
      generatePdfBtn.disabled = true;
      addHeir.disabled = true;
      // Disable all inputs
      [...document.querySelectorAll('#warishForm input, #warishForm button')].forEach(el => {
        if(el !== sendTelegramBtn && el !== contactTelegramBtn) el.disabled = true;
      });
    });

    // Generate PDF function
    function generatePDF() {
      // Prepare content for PDF
      const pdfContent = document.createElement('div');
      pdfContent.id = 'pdfContent';

      // Form values
      const formName = document.getElementById('formName').value.trim();
      const formNumber = document.getElementById('formNumber').value.trim();
      const deceasedName = document.getElementById('deceasedName').value.trim();
      const fatherName = document.getElementById('fatherName').value.trim();
      const mohalla = document.getElementById('mohalla').value.trim();
      const ward = document.getElementById('ward').value.trim();
      const postOffice = document.getElementById('postOffice').value.trim();
      const thana = document.getElementById('thana').value.trim();
      const district = document.getElementById('district').value.trim();

      let html = `
        <h1>ওয়ারিশন সনদ</h1>
        <p><strong>ফর্ম নাম:</strong> ${formName || '—'}</p>
        <p><strong>ফর্ম নম্বর:</strong> ${formNumber || '—'}</p>
        <h3>মৃত ব্যক্তির তথ্য</h3>
        <p><strong>নাম:</strong> ${deceasedName}</p>
        <p><strong>পিতা/স্বামী:</strong> ${fatherName}</p>
        <p><strong>মহল্লা:</strong> ${mohalla}</p>
        <p><strong>ওয়ার্ড নং:</strong> ${ward}</p>
        <p><strong>ডাকঘর:</strong> ${postOffice}</p>
        <p><strong>উপজেলা/থানা:</strong> ${thana}</p>
        <p><strong>জেলা:</strong> ${district}</p>
        <h3>ওয়ারিশদের তালিকা</h3>
        <table>
          <thead>
            <tr>
              <th>ক্রমিক</th><th>নাম</th><th>বয়স</th><th>সম্পর্ক</th><th>মন্তব্য</th>
            </tr>
          </thead>
          <tbody>
      `;

      const heirsBody = document.getElementById('heirsBody');
      const rows = heirsBody.querySelectorAll('tr');
      rows.forEach((row, idx) => {
        const heirName = row.querySelector('input[name="heirName[]"]').value.trim() || '—';
        const age = row.querySelector('input[name="age[]"]').value.trim() || '—';
        const relation = row.querySelector('input[name="relation[]"]').value.trim() || '—';
        const comment = row.querySelector('input[name="comment[]"]').value.trim() || '—';

        html += `<tr>
          <td>${toBanglaNumber(idx + 1)}</td>
          <td>${heirName}</td>
          <td>${age}</td>
          <td>${relation}</td>
          <td>${comment}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      html += `<p><strong>রেফারেন্স কোড:</strong> ${currentReferenceCode}</p>`;

      pdfContent.innerHTML = html;

      const opt = {
        margin:       0.5,
        filename:     `ওয়ারিশন_সনদ_${currentReferenceCode}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(pdfContent).save();
    }

    // Send data to Telegram
    const sendTelegramBtn = document.getElementById('sendTelegramBtn');

    sendTelegramBtn.addEventListener('click', () => {
      sendTelegramBtn.disabled = true;
      sendTelegramBtn.textContent = 'পাঠানো হচ্ছে...';

      // Collect form data for Telegram message
      const formName = document.getElementById('formName').value.trim();
      const formNumber = document.getElementById('formNumber').value.trim();
      const deceasedName = document.getElementById('deceasedName').value.trim();
      const fatherName = document.getElementById('fatherName').value.trim();
      const mohalla = document.getElementById('mohalla').value.trim();
      const ward = document.getElementById('ward').value.trim();
      const postOffice = document.getElementById('postOffice').value.trim();
      const thana = document.getElementById('thana').value.trim();
      const district = document.getElementById('district').value.trim();

      let message = `📝 *ওয়ারিশন সনদ ফরম তথ্য*\n\n`;
      message += `*ফর্ম নাম:* ${formName || '—'}\n`;
      message += `*ফর্ম নম্বর:* ${formNumber || '—'}\n\n`;

      message += `*মৃত ব্যক্তির তথ্য:*\n`;
      message += `নাম: ${deceasedName}\n`;
      message += `পিতা/স্বামী: ${fatherName}\n`;
      message += `মহল্লা: ${mohalla}\n`;
      message += `ওয়ার্ড নং: ${ward}\n`;
      message += `ডাকঘর: ${postOffice}\n`;
      message += `উপজেলা/থানা: ${thana}\n`;
      message += `জেলা: ${district}\n\n`;

      message += `*ওয়ারিশদের তালিকা:*\n`;

      const heirsBody = document.getElementById('heirsBody');
      const rows = heirsBody.querySelectorAll('tr');
      rows.forEach((row, idx) => {
        const heirName = row.querySelector('input[name="heirName[]"]').value.trim() || '—';
        const age = row.querySelector('input[name="age[]"]').value.trim() || '—';
        const relation = row.querySelector('input[name="relation[]"]').value.trim() || '—';
        const comment = row.querySelector('input[name="comment[]"]').value.trim() || '—';

        message += `${toBanglaNumber(idx + 1)}. নাম: ${heirName}, বয়স: ${age}, সম্পর্ক: ${relation}`;
        if(comment !== '—') message += `, মন্তব্য: ${comment}`;
        message += `\n`;
      });

      message += `\nরেফারেন্স কোড: ${currentReferenceCode}`;

      // Send message via Telegram Bot API (use fetch)
      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text: message,
          parse_mode: 'Markdown'
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          alert('তথ্য সফলভাবে টেলিগ্রামে পাঠানো হয়েছে।');
          sendTelegramBtn.disabled = true;
          sendTelegramBtn.textContent = 'টেলিগ্রামে পাঠানো হয়েছে';
        } else {
          alert('টেলিগ্রামে পাঠাতে সমস্যা হয়েছে, পরে আবার চেষ্টা করুন।');
          sendTelegramBtn.disabled = false;
          sendTelegramBtn.textContent = 'টেলিগ্রামের তথ্য পাঠান';
        }
      })
      .catch(() => {
        alert('টেলিগ্রামে পাঠাতে সমস্যা হয়েছে, ইন্টারনেট কানেকশন চেক করুন।');
        sendTelegramBtn.disabled = false;
        sendTelegramBtn.textContent = 'টেলিগ্রামের তথ্য পাঠান';
      });
    });

    // Telegram contact popup logic
    const contactTelegramBtn = document.getElementById('contactTelegramBtn');

    contactTelegramBtn.addEventListener('click', () => {
      telegramContactPopup.style.display = 'flex';
      contactRefCodeInput.value = '';
      contactErrorMsg.style.display = 'none';
      refCodeValidIcon.textContent = '❌';
      refCodeValidIcon.style.color = 'red';
      contactConfirmBtn.disabled = true;
      contactRefCodeInput.focus();
    });

    contactCancelBtn.addEventListener('click', () => {
      telegramContactPopup.style.display = 'none';
    });

    // Validate reference code input realtime
    contactRefCodeInput.addEventListener('input', () => {
      const val = contactRefCodeInput.value.trim().toUpperCase();
      if (val === currentReferenceCode) {
        refCodeValidIcon.textContent = '✔️';
        refCodeValidIcon.style.color = 'green';
        contactConfirmBtn.disabled = false;
        contactErrorMsg.style.display = 'none';
        contactRefCodeInput.classList.remove('invalid');
        contactRefCodeInput.classList.add('valid');
      } else {
        refCodeValidIcon.textContent = '❌';
        refCodeValidIcon.style.color = 'red';
        contactConfirmBtn.disabled = true;
        contactErrorMsg.style.display = 'block';
        contactRefCodeInput.classList.remove('valid');
        contactRefCodeInput.classList.add('invalid');
      }
    });

    // Contact confirm button (redirect to Telegram)
    contactConfirmBtn.addEventListener('click', () => {
      if(contactRefCodeInput.value.trim().toUpperCase() === currentReferenceCode){
        // open telegram chat with username
        const tgUrl = `https://t.me/${TELEGRAM_USERNAME}?text=রেফারেন্স%20কোড%20হলো%20${currentReferenceCode}%20এবং%20আরো%20তথ্য%20আপনার%20ফর্মে%20যথাযথ%20দেওয়া%20হয়েছে।`;
        window.open(tgUrl, '_blank');
        telegramContactPopup.style.display = 'none';
      } else {
        contactErrorMsg.style.display = 'block';
      }
    });

    // Initialize on page load
    window.onload = () => {
      initHeirsTable();
    }
  </script>
</body>

</html>

